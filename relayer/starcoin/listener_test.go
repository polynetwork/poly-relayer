package starcoin

import (
	"encoding/hex"
	"github.com/ontio/ontology/common/log"
	"github.com/polynetwork/poly-relayer/msg"
	"github.com/starcoinorg/starcoin-go/client"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestCrossChainData(t *testing.T) {
	data := "0x1048b75ec5bb72e54bca2633c36ca3eb0410000000000000000000000000000000004140000000000000005800000000000000100000000000000048b75ec5bb72e54bca2633c36ca3eb040f000000000000007a696f6e5f6c6f636b5f70726f787900003e010000000000001048b75ec5bb72e54bca2633c36ca3eb04c102e000000000000000f80000000000000020010000000000003e0100000000000069010000000000008101000000000000a3010000000000001000000000000000000000000000000000000000000000002000000000000000f5220b972969f97023a9669e68c65cf6e87d9a1ad635e1ef5e6208c232b63c16410000000000000040000000000000005800000000000000100000000000000048b75ec5bb72e54bca2633c36ca3eb040f000000000000007a696f6e5f6c6f636b5f70726f78790000100000000000000048b75ec5bb72e54bca2633c36ca3eb040600000000000000756e6c6f636b00000000000000000000000000000000000000003e000000000000000c3078313a3a5354433a3a53541048b75ec5bb72e54bca2633c36ca3eb041027000000000000000000000000000000000000000000000000000000000000"
	eventData, err := HexToBytes(data)
	if err != nil {
		log.Errorf("Scan |  hex.DecodeString error :%s", err.Error())
	}
	crossChainEventData, err := BcsDeserializeCrossChainEvent(eventData)
	if err != nil {
		log.Errorf("fetchLockDepositEvents - BcsDeserializeCrossChainDepositEvent error :%s", err.Error())
	}
	assert.Equal(t, crossChainEventData.ToChainId, uint64(318), "Not equal")
	log.Info(client.BytesToHexString(crossChainEventData.ToContract))
	log.Info(client.BytesToHexString(crossChainEventData.ProxyOrAssetContract))
	log.Info(client.BytesToHexString(crossChainEventData.Sender))
	log.Info(client.BytesToHexString(crossChainEventData.TxId))
}

func TestSrcParam(t *testing.T) {
	// tx hash 0x61a081eeb1e847d53c9afd9f048a05f3a88e9a2f3a1afafc50a89280c5e3dd7c

	srcParam := "0x00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000013e0000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000202c38e0fd45b4eb4a73f7fe12749bd1229dde283399bffabd4e90589c1e561f5700000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000010f08ac0c1c6c8f2be528b35824755054000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f7a696f6e5f6c6f636b5f70726f787900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010f08ac0c1c6c8f2be528b358247550540000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006756e6c6f636b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003f0d3078313a3a5354433a3a5354431048b75ec5bb72e54bca2633c36ca3eb04102700000000000000000000000000000000000000000000000000000000000000"
	raw, err := hex.DecodeString(srcParam[2:])
	if err != nil || len(raw) == 0 {
		assert.Fail(t, "Failed to load")
		//log.Fatal("Unexpected empty SrcParam", "err", err, "hash", srcParam)
	}

	txParam, err := msg.DecodeTxParam(raw)
	if err != nil {
		assert.Fail(t, "Failed to load", err)
	}
	assert.Equal(t, 318, int(txParam.ToChainID))
}
